import{d as G,u as K,k as V,q as U,r as m,i as F,l as z,s as Q,c as l,j as v,b as t,t as o,v as I,n as W,F as x,m as D,h as Z,o as i}from"./a6n2H657.js";import{S as r}from"./BQIkj5Wb.js";const P=window.setInterval,J={class:"container px-3 mb-4"},X={key:0,class:"d-flex justify-content-center align-items-center py-5"},Y={key:1,class:"alert alert-danger text-center"},ee={key:2,class:"row g-4"},te={class:"col-lg-5"},ae={class:"content-card p-3 p-md-4 text-center"},se={class:"qr-container p-3 d-inline-block mb-3"},ne=["src"],le={key:0,class:"alert alert-warning small p-2"},ie={class:"d-grid"},oe=["disabled"],re={class:"col-lg-7"},de={class:"content-card p-3 p-md-4"},ue={class:"transaction-details"},ce={class:"detail-row"},me={class:"detail-row"},ve={class:"detail-row"},pe={class:"detail-row"},ge={class:"detail-row"},fe={key:0},ye={class:"transaction-details"},be={class:"detail-row"},we={class:"detail-row"},ke={class:"text-secondary"},_e={class:"total-row"},he={class:"total-amount"},Ie={key:1},xe={key:0,class:"alert alert-danger small"},De={key:1},Pe=["href","download"],Ce=G({__name:"[id]",setup(Se){K({title:"Invoice"});const N=Z(),{$api:S}=V(),p=U(),R=Array.isArray(p.params.id)?p.params.id[0]:p.params.id,a=m(null),g=m(!0),f=m(null),d=m(""),T=m(!1);let y=null,b=null,u=null;const A=F(()=>a.value?.items.filter(s=>!!s.file)||[]),$=F(()=>{if(!a.value)return"badge bg-secondary";switch(a.value.status){case"Lunas":return"badge bg-success";case"Kadaluwarsa":return"badge bg-danger";case"Pending":return"badge bg-warning text-dark";default:return"badge bg-secondary"}}),w=s=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(s),j=s=>new Date(s).toLocaleString("id-ID",{dateStyle:"medium",timeStyle:"short"}),C=s=>String(s).padStart(2,"0"),c=()=>{y&&clearInterval(y),b&&clearInterval(b),u&&clearInterval(u)},L=()=>{if(!a.value?.paidAt)return;const s=N.public.downloadLinkExpiresInHours||1,n=new Date(a.value.paidAt).getTime()+s*60*60*1e3;Date.now()>n&&(T.value=!0,u&&clearInterval(u))},M=()=>{if(!a.value?.expiresAt||a.value.status!=="Pending"){c(),a.value&&(d.value=`Status: ${a.value.status}`);return}const s=new Date().getTime(),n=new Date(a.value.expiresAt).getTime()-s;if(n<=0){a.value&&(a.value.status="Kadaluwarsa"),d.value="Waktu Habis",c();return}const k=Math.floor(n%(1e3*60*60)/(1e3*60)),_=Math.floor(n%(1e3*60)/1e3);d.value=`${C(k)}:${C(_)}`},q=async(s=!1)=>{if(!(!a.value||a.value.status!=="Pending")){s&&r.fire({title:"Mengecek status...",didOpen:()=>r.showLoading(),allowOutsideClick:!1});try{(await S("/api/v1/check",{method:"POST",body:{id:a.value.id}})).status?(await B(),r.close(),r.fire("Pembayaran Berhasil!","Terima kasih telah melakukan pembayaran.","success")):s&&r.fire("Masih Pending","Pembayaran untuk invoice ini belum terdeteksi.","info")}catch{s&&r.fire("Error","Gagal menghubungi server untuk cek status.","error")}}},H=()=>q(!0),B=async()=>{try{g.value=!0;const s=await S(`/api/v1/invoice?id=${R}`);if(!s||!s.status||!s.data)throw new Error("Invoice tidak ditemukan.");const e=s.data,n=e.items?.reduce((h,E)=>h+Number(E.price)*E.quantity,0),k=e.amount-n,_=new Date(e.created_at),O=new Date(_.getTime()+600*1e3).toISOString();a.value={id:e._id,status:e.status==="Paid"?"Lunas":e.status,email:e.email,createdAt:e.created_at,paidAt:e.paid_at,expiresAt:O,items:e.items.map(h=>({...h})),fee:k,total:e.amount,qr:e.qr,paymentMethod:e.payment_method,additionalInformation:e.additional_information||[]},c(),a.value.status==="Pending"?(M(),y=P(M,1e3),b=P(()=>q(!1),5e3)):a.value.status==="Lunas"&&(L(),u=P(L,6e4))}catch(s){console.log(s),f.value=s.data?.message||"Gagal memuat detail invoice.",c()}finally{g.value=!1}};return z(B),Q(c),(s,e)=>(i(),l("div",J,[g.value?(i(),l("div",X,e[0]||(e[0]=[t("div",{class:"spinner-border product-loader-spinner",role:"status"},null,-1),t("p",{class:"ms-3 mb-0"},"Loading...",-1)]))):f.value?(i(),l("div",Y,[e[1]||(e[1]=t("h5",null,"Gagal Memuat Data",-1)),t("p",null,o(f.value),1)])):a.value?(i(),l("div",ee,[t("div",te,[t("div",ae,[e[3]||(e[3]=t("h5",{class:"mb-3"},"Pindai untuk Membayar",-1)),t("div",se,[t("img",{src:a.value.qr,alt:"QRIS Payment Code"},null,8,ne)]),d.value?(i(),l("div",le,[e[2]||(e[2]=I(" Bayar sebelum: ",-1)),t("strong",null,o(d.value),1)])):v("",!0),t("div",ie,[t("button",{class:"btn btn-secondary mt-2",onClick:H,disabled:a.value.status==="Lunas"||a.value.status==="Kadaluwarsa"},"Cek Status Pembayaran",8,oe)])])]),t("div",re,[t("div",de,[e[17]||(e[17]=t("div",{class:"d-flex justify-content-between align-items-center mb-4"},[t("h4",null,"Detail Transaksi")],-1)),t("div",ue,[t("div",ce,[e[4]||(e[4]=t("span",null,"Status",-1)),t("strong",null,[t("span",{class:W($.value)},o(a.value.status),3)])]),t("div",me,[e[5]||(e[5]=t("span",null,"ID Transaksi",-1)),t("strong",null,o(a.value.id),1)]),t("div",ve,[e[6]||(e[6]=t("span",null,"Email",-1)),t("strong",null,o(a.value.email),1)]),t("div",pe,[e[7]||(e[7]=t("span",null,"Tanggal",-1)),t("strong",null,o(j(a.value.createdAt)),1)]),t("div",ge,[e[8]||(e[8]=t("span",null,"Metode Pembayaran",-1)),t("strong",null,o(a.value.paymentMethod.toUpperCase()),1)])]),a.value.additionalInformation&&a.value.additionalInformation.length>0?(i(),l("div",fe,[e[9]||(e[9]=t("hr",{class:"my-3"},null,-1)),e[10]||(e[10]=t("h6",{class:"mb-2"},"Informasi Pesanan",-1)),t("div",ye,[(i(!0),l(x,null,D(a.value.additionalInformation,n=>(i(),l("div",{key:n.name,class:"detail-row"},[t("span",null,o(n.name),1),t("strong",null,o(n.value),1)]))),128))])])):v("",!0),e[18]||(e[18]=t("hr",{class:"my-3"},null,-1)),e[19]||(e[19]=t("h6",{class:"mb-2"},"Ringkasan Pesanan",-1)),(i(!0),l(x,null,D(a.value.items,n=>(i(),l("div",{class:"product-details",key:n.name},[t("div",be,[t("span",null,o(n.name)+" (x"+o(n.quantity)+")",1),t("span",null,o(w(n.price)),1)])]))),128)),t("div",we,[e[11]||(e[11]=t("span",{class:"text-secondary"},"Biaya Penanganan",-1)),t("span",ke,o(w(a.value.fee)),1)]),e[20]||(e[20]=t("hr",{class:"my-3"},null,-1)),t("div",_e,[e[12]||(e[12]=t("span",null,"Total Pembayaran",-1)),t("span",he,o(w(a.value.total)),1)]),a.value.status==="Lunas"&&A.value.length>0?(i(),l("div",Ie,[e[15]||(e[15]=t("hr",{class:"my-3"},null,-1)),e[16]||(e[16]=t("h6",{class:"mb-3"},"File Download",-1)),T.value?(i(),l("div",xe,e[13]||(e[13]=[t("i",{class:"bi bi-clock-history me-2"},null,-1),I(" Sesi unduhan telah berakhir. Silakan hubungi admin jika Anda mengalami kendala. ",-1)]))):(i(),l("div",De,[(i(!0),l(x,null,D(A.value,n=>(i(),l("div",{key:n.name,class:"d-grid mb-2"},[t("a",{href:n.file.data,download:n.file.type==="local",target:"_blank",rel:"noopener noreferrer",class:"btn btn-success"},e[14]||(e[14]=[t("i",{class:"bi bi-download me-2"},null,-1),I(" Download ",-1)]),8,Pe)]))),128))]))])):v("",!0)])])])):v("",!0)]))}});export{Ce as default};
